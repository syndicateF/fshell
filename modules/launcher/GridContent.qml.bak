pragma ComponentBehavior: Bound

import "items"
import "services"
import qs.components
import qs.components.controls
import qs.components.containers
import qs.services
import qs.config
import Quickshell
import QtQuick

Item {
    id: root

    required property var content
    required property PersistentProperties visibilities
    required property var panels
    required property StyledTextField search
    required property int currentTab
    required property int padding
    required property int rounding

    readonly property int columns: Config.launcher.columns
    readonly property int itemWidth: Config.launcher.sizes.itemWidth
    readonly property int itemHeight: Config.launcher.sizes.itemHeight
    readonly property int gridSpacing: Appearance.spacing.smaller

    // 6 tabs: 0=Apps, 1=Commands, 2=Calc, 3=Schemes, 4=Wallpapers, 5=Variants
    readonly property var currentList: {
        switch (currentTab) {
            case 0: return appsGrid;
            case 1: return commandsGrid;
            case 2: return calcGrid;
            case 3: return schemesGrid;
            case 4: return wallpapersGrid;
            case 5: return variantsGrid;
            default: return appsGrid;
        }
    }

    implicitWidth: Config.launcher.sizes.gridWidth
    implicitHeight: (itemHeight + gridSpacing) * 3 - gridSpacing

    // Navigation functions with auto-scroll
    function navigateUp(): void {
        const grid = currentList;
        if (!grid) return;
        const newIndex = grid.currentIndex - columns;
        if (newIndex >= 0) {
            grid.currentIndex = newIndex;
            grid.positionViewAtIndex(newIndex, GridView.Contain);
        }
    }

    function navigateDown(): void {
        const grid = currentList;
        if (!grid) return;
        const newIndex = grid.currentIndex + columns;
        if (newIndex < grid.count) {
            grid.currentIndex = newIndex;
            grid.positionViewAtIndex(newIndex, GridView.Contain);
        }
    }

    function navigateLeft(): void {
        const grid = currentList;
        if (!grid) return;
        if (grid.currentIndex > 0) {
            grid.currentIndex--;
            grid.positionViewAtIndex(grid.currentIndex, GridView.Contain);
        }
    }

    function navigateRight(): void {
        const grid = currentList;
        if (!grid) return;
        if (grid.currentIndex < grid.count - 1) {
            grid.currentIndex++;
            grid.positionViewAtIndex(grid.currentIndex, GridView.Contain);
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 0: APPS
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: appsGrid

        visible: root.currentTab === 0
        anchors.fill: parent

        cellWidth: root.itemWidth + root.gridSpacing
        cellHeight: root.itemHeight + root.gridSpacing

        model: ScriptModel {
            values: Apps.search(root.search.text)
            onValuesChanged: appsGrid.currentIndex = 0
        }

        clip: true
        interactive: true
        boundsBehavior: Flickable.StopAtBounds

        highlight: GridHighlight { targetGrid: appsGrid }
        highlightFollowsCurrentItem: false

        delegate: GridAppItem {
            width: root.itemWidth
            height: root.itemHeight
            isSelected: GridView.isCurrentItem
            visibilities: root.visibilities

            onClicked: {
                appsGrid.currentIndex = index;
                Apps.launch(modelData);
                root.visibilities.launcher = false;
            }

            onHovered: appsGrid.currentIndex = index
        }

        StyledScrollBar.vertical: StyledScrollBar {
            flickable: appsGrid
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 1: COMMANDS
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: commandsGrid

        visible: root.currentTab === 1
        anchors.fill: parent

        cellWidth: root.itemWidth + root.gridSpacing
        cellHeight: root.itemHeight + root.gridSpacing

        model: ScriptModel {
            values: Actions.query(root.search.text)
            onValuesChanged: commandsGrid.currentIndex = 0
        }

        clip: true
        interactive: true
        boundsBehavior: Flickable.StopAtBounds

        highlight: GridHighlight { targetGrid: commandsGrid }
        highlightFollowsCurrentItem: false

        delegate: GridCommandItem {
            width: root.itemWidth
            height: root.itemHeight
            isSelected: GridView.isCurrentItem
            gridContent: root

            onClicked: {
                commandsGrid.currentIndex = index;
                modelData.onClicked(commandsGrid, root);
            }

            onHovered: commandsGrid.currentIndex = index
        }

        StyledScrollBar.vertical: StyledScrollBar {
            flickable: commandsGrid
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 2: CALCULATOR
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: calcGrid

        visible: root.currentTab === 2
        anchors.fill: parent

        cellWidth: Config.launcher.sizes.gridWidth
        cellHeight: root.itemHeight + root.gridSpacing

        model: ScriptModel {
            values: [0]
        }

        clip: true

        delegate: GridCalcItem {
            width: Config.launcher.sizes.gridWidth - root.gridSpacing * 2
            height: root.itemHeight
            isSelected: GridView.isCurrentItem
            search: root.search
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 3: SCHEMES
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: schemesGrid

        visible: root.currentTab === 3
        anchors.fill: parent

        cellWidth: root.itemWidth + root.gridSpacing
        cellHeight: root.itemHeight + root.gridSpacing

        model: ScriptModel {
            values: Schemes.query(root.search.text)
            onValuesChanged: schemesGrid.currentIndex = 0
        }

        clip: true
        interactive: true
        boundsBehavior: Flickable.StopAtBounds

        highlight: GridHighlight { targetGrid: schemesGrid }
        highlightFollowsCurrentItem: false

        delegate: GridSchemeItem {
            width: root.itemWidth
            height: root.itemHeight
            isSelected: GridView.isCurrentItem
            visibilities: root.visibilities

            onClicked: {
                schemesGrid.currentIndex = index;
                modelData.onClicked(schemesGrid);
            }

            onHovered: schemesGrid.currentIndex = index
        }

        StyledScrollBar.vertical: StyledScrollBar {
            flickable: schemesGrid
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 4: WALLPAPERS
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: wallpapersGrid

        visible: root.currentTab === 4
        anchors.fill: parent

        cellWidth: Config.launcher.sizes.wallpaperWidth + root.gridSpacing
        cellHeight: Config.launcher.sizes.wallpaperHeight + root.gridSpacing

        model: ScriptModel {
            values: Wallpapers.query(root.search.text)
            onValuesChanged: wallpapersGrid.currentIndex = 0
        }

        clip: true
        interactive: true
        boundsBehavior: Flickable.StopAtBounds

        highlight: WallpaperHighlight {}
        highlightFollowsCurrentItem: false

        delegate: GridWallpaperItem {
            width: Config.launcher.sizes.wallpaperWidth
            height: Config.launcher.sizes.wallpaperHeight
            isSelected: GridView.isCurrentItem
            visibilities: root.visibilities
            panels: root.panels
            content: root.content

            onClicked: {
                wallpapersGrid.currentIndex = index;
                if (Colours.scheme === "dynamic" && modelData.path !== Wallpapers.actualCurrent)
                    Wallpapers.previewColourLock = true;
                Wallpapers.setWallpaper(modelData.path);
                root.visibilities.launcher = false;
            }

            onHovered: wallpapersGrid.currentIndex = index
        }

        StyledScrollBar.vertical: StyledScrollBar {
            flickable: wallpapersGrid
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB 5: VARIANTS
    // ═══════════════════════════════════════════════════════════════
    GridView {
        id: variantsGrid

        visible: root.currentTab === 5
        anchors.fill: parent

        cellWidth: root.itemWidth + root.gridSpacing
        cellHeight: root.itemHeight + root.gridSpacing

        model: ScriptModel {
            values: M3Variants.query(root.search.text)
            onValuesChanged: variantsGrid.currentIndex = 0
        }

        clip: true
        interactive: true
        boundsBehavior: Flickable.StopAtBounds

        highlight: GridHighlight { targetGrid: variantsGrid }
        highlightFollowsCurrentItem: false

        delegate: GridVariantItem {
            width: root.itemWidth
            height: root.itemHeight
            isSelected: GridView.isCurrentItem
            visibilities: root.visibilities

            onClicked: {
                variantsGrid.currentIndex = index;
                modelData.onClicked(variantsGrid);
            }

            onHovered: variantsGrid.currentIndex = index
        }

        StyledScrollBar.vertical: StyledScrollBar {
            flickable: variantsGrid
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // SHARED COMPONENTS
    // ═══════════════════════════════════════════════════════════════
    component GridHighlight: StyledRect {
        required property GridView targetGrid

        radius: Appearance.rounding.small
        color: Colours.palette.m3primaryContainer

        x: targetGrid.currentItem?.x ?? 0
        y: targetGrid.currentItem?.y ?? 0
        width: root.itemWidth
        height: root.itemHeight

        Behavior on x {
            Anim {
                duration: Appearance.anim.durations.small
                easing.bezierCurve: Appearance.anim.curves.standard
            }
        }

        Behavior on y {
            Anim {
                duration: Appearance.anim.durations.small
                easing.bezierCurve: Appearance.anim.curves.standard
            }
        }
    }

    component WallpaperHighlight: StyledRect {
        radius: Appearance.rounding.small
        color: Colours.palette.m3primaryContainer

        x: wallpapersGrid.currentItem?.x ?? 0
        y: wallpapersGrid.currentItem?.y ?? 0
        width: Config.launcher.sizes.wallpaperWidth
        height: Config.launcher.sizes.wallpaperHeight

        Behavior on x {
            Anim {
                duration: Appearance.anim.durations.small
                easing.bezierCurve: Appearance.anim.curves.standard
            }
        }

        Behavior on y {
            Anim {
                duration: Appearance.anim.durations.small
                easing.bezierCurve: Appearance.anim.curves.standard
            }
        }
    }

    // Reload schemes when entering schemes tab
    onCurrentTabChanged: {
        if (currentTab === 3) {
            Schemes.reload();
        }
    }
}
